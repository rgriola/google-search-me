<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Schema Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            padding: 0;
            background-color: #f4f4f9;
        }
        
        h1, h2, h3, h4 {
            color: #333;
        }
        
        h1 {
            text-align: center;
            margin-top: 20px;
        }
        
        h2 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        h3 {
            margin-top: 20px;
        }
        
        ul {
            list-style-type: none;
            padding: 0;
        }
        
        li {
            margin: 5px 0;
        }
        
        a {
            text-decoration: none;
            color: #007bff;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #007bff;
            color: white;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        #deleteAllBtn {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        #deleteAllBtn:hover {
            background-color: #b71c1c !important;
            transform: scale(1.02);
        }
        
        #deleteAllBtn:disabled {
            background-color: #999 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        hr {
            margin-top: 40px;
            border-color: #ff0000;
        }
        
        .danger-zone {
            background-color: #fff5f5;
            border: 2px solid #ff6b6b;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .danger-zone h2 {
            color: #d63031;
            margin-top: 0;
        }
        
        .danger-zone p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .danger-zone button {
            background-color: #d93025;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Database Schema Viewer</h1>
    
    <h2>Database Files</h2>
    <ul>
        <li><a href="#locations-db">locations.db</a></li>
    </ul>
    
    <hr>
    
    <div id="locations-db">
        <h2>locations.db</h2>
        <p>SQLite Database containing user accounts, saved locations, and session data.</p>
        
        <h3>Tables</h3>
        <ul>
            <li><a href="#table-users">users</a> - User accounts and authentication</li>
            <li><a href="#table-saved-locations">saved_locations</a> - Location data saved by users</li>
            <li><a href="#table-user-saves">user_saves</a> - Relationship between users and their saved locations</li>
            <li><a href="#table-user-sessions">user_sessions</a> - User session management</li>
        </ul>
        
        <hr>
        
        <div id="table-users">
            <h3>users Table</h3>
            <button onclick="loadTableData('users')">Load Data</button>
            <div id="schema-users"></div>
            <div id="data-users"></div>
        </div>
        
        <hr>
        
        <div id="table-saved-locations">
            <h3>saved_locations Table</h3>
            <button onclick="loadTableData('saved_locations')">Load Data</button>
            <div id="schema-saved_locations"></div>
            <div id="data-saved_locations"></div>
        </div>
        
        <hr>
        
        <div id="table-user-saves">
            <h3>user_saves Table</h3>
            <button onclick="loadTableData('user_saves')">Load Data</button>
            <div id="schema-user_saves"></div>
            <div id="data-user_saves"></div>
        </div>
        
        <hr>
        
        <div id="table-user-sessions">
            <h3>user_sessions Table</h3>
            <button onclick="loadTableData('user_sessions')">Load Data</button>
            <div id="schema-user_sessions"></div>
            <div id="data-user_sessions"></div>
        </div>
    </div>

    <hr>
    
    <div class="danger-zone">
        <h2>‚ö†Ô∏è Danger Zone</h2>
        <p>
            <strong>WARNING:</strong> This action will permanently delete ALL data from ALL tables in the database. 
            This cannot be undone!
        </p>
        <button id="deleteAllBtn" onclick="confirmDeleteAllData()">
            üóëÔ∏è Delete All Data
        </button>
    </div>

    <script>
        async function loadTableData(tableName) {
            try {
                // Load schema
                const schemaResponse = await fetch(`/api/database/schema/${tableName}`);
                const schemaData = await schemaResponse.json();
                
                // Load data
                const dataResponse = await fetch(`/api/database/data/${tableName}`);
                const tableData = await dataResponse.json();
                
                // Display schema
                displaySchema(tableName, schemaData);
                
                // Display data
                displayTableData(tableName, tableData);
                
            } catch (error) {
                console.error('Error loading table data:', error);
                document.getElementById(`schema-${tableName}`).innerHTML = '<p>Error loading schema</p>';
                document.getElementById(`data-${tableName}`).innerHTML = '<p>Error loading data</p>';
            }
        }
        
        function displaySchema(tableName, schema) {
            const schemaDiv = document.getElementById(`schema-${tableName}`);
            
            let html = '<h4>Schema</h4><table border="1"><tr><th>Column</th><th>Type</th><th>Constraints</th></tr>';
            
            schema.forEach(column => {
                html += `<tr>
                    <td>${column.name}</td>
                    <td>${column.type}</td>
                    <td>${column.constraints || ''}</td>
                </tr>`;
            });
            
            html += '</table>';
            schemaDiv.innerHTML = html;
        }
        
        function displayTableData(tableName, data) {
            const dataDiv = document.getElementById(`data-${tableName}`);
            
            if (!data || data.length === 0) {
                dataDiv.innerHTML = '<h4>Data</h4><p>No data found</p>';
                return;
            }
            
            // Get column names from first row
            const columns = Object.keys(data[0]);
            
            let html = `<h4>Data (${data.length} rows)</h4><table border="1"><tr>`;
            
            // Header row
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr>';
            
            // Data rows
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    if (value === null) value = 'NULL';
                    if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            dataDiv.innerHTML = html;
        }
        
        async function confirmDeleteAllData() {
            // First confirmation
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL data from the database!\n\nThis includes:\n- All users\n- All saved locations\n- All sessions\n- All other data\n\nAre you absolutely sure you want to continue?')) {
                return;
            }
            
            // Second confirmation
            if (!confirm('üö® FINAL WARNING: This action CANNOT be undone!\n\nAll data will be permanently lost forever.\n\nDo you really want to delete ALL data?')) {
                return;
            }
            
            // Third confirmation - type DELETE
            const userInput = prompt('To confirm this destructive action, please type "DELETE" (all caps):');
            if (userInput !== 'DELETE') {
                alert('‚ùå Action cancelled. You must type "DELETE" exactly to confirm.');
                return;
            }
            
            // Show loading state
            const deleteBtn = document.getElementById('deleteAllBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = 'üîÑ Deleting...';
            deleteBtn.disabled = true;
            
            try {
                const response = await fetch('/api/database/delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Success: ${result.message}\n\nTables cleared: ${result.tablesCleared.join(', ')}`);
                    
                    // Clear all displayed data
                    const dataDivs = document.querySelectorAll('[id^="data-"]');
                    dataDivs.forEach(div => {
                        div.innerHTML = '<h4>Data</h4><p>No data found (deleted)</p>';
                    });
                    
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.error}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error deleting data:', error);
                alert('‚ùå Error deleting data: ' + error.message);
            } finally {
                // Restore button
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
