<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Schema Viewer</title>
    <link rel="stylesheet" href="css/dbViewer.css">
</head>
<body>
    <h1>Database Schema Viewer</h1>
    <div id="auth-status" style="text-align: center; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <span id="auth-message">Checking authentication...</span>
    </div>
    
    <h2>Database Files</h2>
    <ul>
        <li><a href="#locations-db">locations.db</a></li>
    </ul>
    
    <hr>
    
    <div id="locations-db">
        <h2>locations.db</h2>
        <p>SQLite Database containing user accounts, saved locations, and session data.</p>
        
        <h3>Tables</h3>
        <ul>
            <li><a href="#table-users">users</a> - User accounts and authentication</li>
            <li><a href="#table-saved-locations">saved_locations</a> - Location data saved by users</li>
            <li><a href="#table-user-saves">user_saves</a> - Relationship between users and their saved locations</li>
            <li><a href="#table-user-sessions">user_sessions</a> - User session management</li>
        </ul>
        
        <hr>
        
        <div id="table-users">
            <h3>users Table</h3>
            <button onclick="loadTableData('users')">Load Data</button>
            <div id="schema-users"></div>
            <div id="data-users"></div>
        </div>
        
        <hr>
        
        <div id="table-saved-locations">
            <h3>saved_locations Table</h3>
            <button onclick="loadTableData('saved_locations')">Load Data</button>
            <div id="schema-saved_locations"></div>
            <div id="data-saved_locations"></div>
        </div>
        
        <hr>
        
        <div id="table-user-saves">
            <h3>user_saves Table</h3>
            <button onclick="loadTableData('user_saves')">Load Data</button>
            <div id="schema-user_saves"></div>
            <div id="data-user_saves"></div>
        </div>
        
        <hr>
        
        <div id="table-user-sessions">
            <h3>user_sessions Table</h3>
            <button onclick="loadTableData('user_sessions')">Load Data</button>
            <div id="schema-user_sessions"></div>
            <div id="data-user_sessions"></div>
        </div>
    </div>

    <hr>
    
    <div class="danger-zone">
        <h2>‚ö†Ô∏è Danger Zone</h2>
        <p>
            <strong>WARNING:</strong> This action will permanently delete ALL data from ALL tables in the database. 
            This cannot be undone!
        </p>
        <button id="deleteAllBtn" onclick="confirmDeleteAllData()">
            üóëÔ∏è Delete All Data
        </button>
    </div>

    <script>
        // Check authentication status on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });
        
        async function checkAuthStatus() {
            const authStatusDiv = document.getElementById('auth-status');
            const authMessage = document.getElementById('auth-message');
            
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                authStatusDiv.style.backgroundColor = '#fff3cd';
                authStatusDiv.style.border = '1px solid #ffeaa7';
                authMessage.innerHTML = '‚ö†Ô∏è No authentication found. Admin functions will not work. <a href="login.html" style="color: #007bff;">Log in here</a>';
                return;
            }
            
            try {
                // Verify token with server
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.user && userData.user.isAdmin) {
                        authStatusDiv.style.backgroundColor = '#d4edda';
                        authStatusDiv.style.border = '1px solid #c3e6cb';
                        authMessage.innerHTML = `‚úÖ Authenticated as admin: ${userData.user.username || userData.user.email}`;
                    } else {
                        authStatusDiv.style.backgroundColor = '#f8d7da';
                        authStatusDiv.style.border = '1px solid #f5c6cb';
                        authMessage.innerHTML = `‚ùå Authenticated but not an admin: ${userData.user.username || userData.user.email}`;
                    }
                } else {
                    authStatusDiv.style.backgroundColor = '#f8d7da';
                    authStatusDiv.style.border = '1px solid #f5c6cb';
                    authMessage.innerHTML = '‚ùå Invalid authentication. <a href="login.html" style="color: #007bff;">Please log in again</a>';
                }
            } catch (error) {
                authStatusDiv.style.backgroundColor = '#f8d7da';
                authStatusDiv.style.border = '1px solid #f5c6cb';
                authMessage.innerHTML = '‚ùå Error checking authentication. <a href="login.html" style="color: #007bff;">Please log in</a>';
            }
        }
        
        async function loadTableData(tableName) {
            try {
                // Load schema
                const schemaResponse = await fetch(`/api/database/schema/${tableName}`);
                const schemaData = await schemaResponse.json();
                
                // Load data
                const dataResponse = await fetch(`/api/database/data/${tableName}`);
                const tableData = await dataResponse.json();
                
                // Display schema
                displaySchema(tableName, schemaData);
                
                // Display data
                displayTableData(tableName, tableData);
                
            } catch (error) {
                console.error('Error loading table data:', error);
                document.getElementById(`schema-${tableName}`).innerHTML = '<p>Error loading schema</p>';
                document.getElementById(`data-${tableName}`).innerHTML = '<p>Error loading data</p>';
            }
        }
        
        function displaySchema(tableName, schema) {
            const schemaDiv = document.getElementById(`schema-${tableName}`);
            
            let html = '<h4>Schema</h4><table border="1"><tr><th>Column</th><th>Type</th><th>Constraints</th></tr>';
            
            schema.forEach(column => {
                html += `<tr>
                    <td>${column.name}</td>
                    <td>${column.type}</td>
                    <td>${column.constraints || ''}</td>
                </tr>`;
            });
            
            html += '</table>';
            schemaDiv.innerHTML = html;
        }
        
        function displayTableData(tableName, data) {
            const dataDiv = document.getElementById(`data-${tableName}`);
            
            if (!data || data.length === 0) {
                dataDiv.innerHTML = '<h4>Data</h4><p>No data found</p>';
                return;
            }
            
            // Get column names from first row
            const columns = Object.keys(data[0]);
            
            let html = `<h4>Data (${data.length} rows)</h4><table border="1"><tr>`;
            
            // Header row
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            
            // Add admin controls column for users table
            if (tableName === 'users') {
                html += '<th>Admin Controls</th>';
            }
            
            html += '</tr>';
            
            // Data rows
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    if (value === null) value = 'NULL';
                    if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    html += `<td>${value}</td>`;
                });
                
                // Add admin controls for users table
                if (tableName === 'users') {
                    const userId = row.id;
                    const isAdmin = row.is_admin || row.isAdmin;
                    const isActive = row.is_active !== undefined ? row.is_active : row.isActive;
                    
                    html += `<td style="white-space: nowrap; text-align: center;">
                        <button onclick="toggleUserAdmin(${userId}, ${!isAdmin})" 
                                class="admin-control-btn ${isAdmin ? 'admin-remove' : 'admin-make'}">
                            ${isAdmin ? 'üë§ Remove Admin' : 'üõ°Ô∏è Make Admin'}
                        </button>
                        <br>
                        <button onclick="toggleUserActive(${userId}, ${!isActive})" 
                                class="admin-control-btn ${isActive ? 'user-deactivate' : 'user-activate'}">
                            ${isActive ? 'üîí Deactivate' : '‚úÖ Activate'}
                        </button>
                    </td>`;
                }
                
                html += '</tr>';
            });
            
            html += '</table>';
            dataDiv.innerHTML = html;
        }
        
        async function confirmDeleteAllData() {
            // First confirmation
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL data from the database!\n\nThis includes:\n- All users\n- All saved locations\n- All sessions\n- All other data\n\nAre you absolutely sure you want to continue?')) {
                return;
            }
            
            // Second confirmation
            if (!confirm('üö® FINAL WARNING: This action CANNOT be undone!\n\nAll data will be permanently lost forever.\n\nDo you really want to delete ALL data?')) {
                return;
            }
            
            // Third confirmation - type DELETE
            const userInput = prompt('To confirm this destructive action, please type "DELETE" (all caps):');
            if (userInput !== 'DELETE') {
                alert('‚ùå Action cancelled. You must type "DELETE" exactly to confirm.');
                return;
            }
            
            // Show loading state
            const deleteBtn = document.getElementById('deleteAllBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = 'üîÑ Deleting...';
            deleteBtn.disabled = true;
            
            try {
                const response = await fetch('/api/database/delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Success: ${result.message}\n\nTables cleared: ${result.tablesCleared.join(', ')}`);
                    
                    // Clear all displayed data
                    const dataDivs = document.querySelectorAll('[id^="data-"]');
                    dataDivs.forEach(div => {
                        div.innerHTML = '<h4>Data</h4><p>No data found (deleted)</p>';
                    });
                    
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.error}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error deleting data:', error);
                alert('‚ùå Error deleting data: ' + error.message);
            } finally {
                // Restore button
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }
        
        async function toggleUserAdmin(userId, makeAdmin) {
            const action = makeAdmin ? 'promote' : 'demote';
            const actionText = makeAdmin ? 'promote to admin' : 'remove admin privileges';
            
            if (!confirm(`Are you sure you want to ${actionText} for user ID ${userId}?`)) {
                return;
            }
            
            // Get auth token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('‚ùå Error: No authentication token found. Please log in to the main app first.');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action: action })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Success: ${result.message}`);
                    
                    // Reload the users table data
                    loadTableData('users');
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.error || 'Failed to update user admin status'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating user admin status:', error);
                alert('‚ùå Error updating user admin status: ' + error.message);
            }
        }
        
        async function toggleUserActive(userId, makeActive) {
            const action = makeActive ? 'activate' : 'deactivate';
            
            if (!confirm(`Are you sure you want to ${action} user ID ${userId}?`)) {
                return;
            }
            
            // Get auth token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('‚ùå Error: No authentication token found. Please log in to the main app first.');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action: action })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Success: ${result.message}`);
                    
                    // Reload the users table data
                    loadTableData('users');
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.error || 'Failed to update user active status'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating user active status:', error);
                alert('‚ùå Error updating user active status: ' + error.message);
            }
        }
    </script>
</body>
</html>
