<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Diagnostic Tool</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        .clear-button { background: #dc3545; }
        .clear-button:hover { background: #c82333; }
        .timestamp { 
            font-weight: bold; 
            color: #007bff; 
            font-size: 1.2em; 
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Cache Diagnostic Tool</h1>
    <p>This tool helps diagnose cache issues by testing various cache mechanisms and providing clear actions.</p>

    <div class="test-section">
        <h2>ðŸ“‹ Cache Status Check</h2>
        <button onclick="checkCacheStatus()">Run Cache Diagnostics</button>
        <div id="cacheResults"></div>
    </div>

    <div class="test-section">
        <h2>ðŸš€ Resource Loading Test</h2>
        <p>Test if resources are loading with current version parameters:</p>
        <button onclick="testResourceLoading()">Test Resource Loading</button>
        <div id="resourceResults"></div>
    </div>

    <div class="test-section">
        <h2>ðŸ§¹ Manual Cache Clearing</h2>
        <button onclick="clearAllCaches()" class="clear-button">Clear All Browser Caches</button>
        <button onclick="reloadWithoutCache()" class="clear-button">Hard Reload Page</button>
        <button onclick="clearServiceWorkers()" class="clear-button">Clear Service Workers</button>
        <div id="clearResults"></div>
    </div>

    <div class="test-section">
        <h2>ðŸ“Š Current Timestamps</h2>
        <div class="timestamp" id="currentTimestamp"></div>
        <div class="timestamp" id="environmentVersion"></div>
    </div>

    <script type="module">
        // Import environment to get current version
        import { environment } from './js/modules/environment.js';

        function updateTimestamps() {
            const now = new Date().toISOString();
            const version = environment?.version || 'Not Found';
            
            document.getElementById('currentTimestamp').textContent = `Current Time: ${now}`;
            document.getElementById('environmentVersion').textContent = `Environment Version: ${version}`;
        }

        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(div);
        }

        window.checkCacheStatus = async function() {
            const container = document.getElementById('cacheResults');
            container.innerHTML = '';
            
            logResult('cacheResults', 'Starting cache diagnostics...', 'info');
            
            // Check localStorage
            const lsKeys = Object.keys(localStorage);
            logResult('cacheResults', `LocalStorage items: ${lsKeys.length}`, lsKeys.length > 0 ? 'error' : 'success');
            
            // Check sessionStorage
            const ssKeys = Object.keys(sessionStorage);
            logResult('cacheResults', `SessionStorage items: ${ssKeys.length}`, ssKeys.length > 0 ? 'error' : 'success');
            
            // Check for service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                logResult('cacheResults', `Service Workers: ${registrations.length}`, registrations.length > 0 ? 'error' : 'success');
            }
            
            // Check cache API
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                logResult('cacheResults', `Cache API caches: ${cacheNames.length}`, cacheNames.length > 0 ? 'error' : 'success');
                cacheNames.forEach(name => {
                    logResult('cacheResults', `- Cache: ${name}`, 'error');
                });
            }
            
            // Check current version
            const currentVersion = environment?.version || 'Unknown';
            logResult('cacheResults', `Current app version: ${currentVersion}`, 'info');
        };

        window.testResourceLoading = async function() {
            const container = document.getElementById('resourceResults');
            container.innerHTML = '';
            
            logResult('resourceResults', 'Testing resource loading...', 'info');
            
            const resources = [
                'css/styles.css',
                'css/security-enhanced.css',
                'js/modules/environment.js',
                'js/app-page.js'
            ];
            
            const version = environment?.version || Date.now();
            
            for (const resource of resources) {
                try {
                    const url = `${resource}?v=${version}&t=${Date.now()}`;
                    const response = await fetch(url, { cache: 'no-cache' });
                    const cacheStatus = response.headers.get('cache-control') || 'No cache header';
                    
                    logResult('resourceResults', 
                        `${resource}: ${response.status} (Cache: ${cacheStatus})`, 
                        response.ok ? 'success' : 'error'
                    );
                } catch (error) {
                    logResult('resourceResults', `${resource}: Failed - ${error.message}`, 'error');
                }
            }
        };

        window.clearAllCaches = async function() {
            const container = document.getElementById('clearResults');
            container.innerHTML = '';
            
            logResult('clearResults', 'Clearing all browser caches...', 'info');
            
            // Clear localStorage
            try {
                localStorage.clear();
                logResult('clearResults', 'LocalStorage cleared', 'success');
            } catch (e) {
                logResult('clearResults', `LocalStorage clear failed: ${e.message}`, 'error');
            }
            
            // Clear sessionStorage
            try {
                sessionStorage.clear();
                logResult('clearResults', 'SessionStorage cleared', 'success');
            } catch (e) {
                logResult('clearResults', `SessionStorage clear failed: ${e.message}`, 'error');
            }
            
            // Clear Cache API
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        logResult('clearResults', `Cache API '${cacheName}' deleted`, 'success');
                    }
                } catch (e) {
                    logResult('clearResults', `Cache API clear failed: ${e.message}`, 'error');
                }
            }
            
            logResult('clearResults', 'Manual cache clearing complete. Reload page to see changes.', 'success');
        };

        window.clearServiceWorkers = async function() {
            const container = document.getElementById('clearResults');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        logResult('clearResults', `Service Worker unregistered: ${registration.scope}`, 'success');
                    }
                    if (registrations.length === 0) {
                        logResult('clearResults', 'No service workers found', 'success');
                    }
                } catch (e) {
                    logResult('clearResults', `Service Worker clearing failed: ${e.message}`, 'error');
                }
            } else {
                logResult('clearResults', 'Service Workers not supported', 'info');
            }
        };

        window.reloadWithoutCache = function() {
            logResult('clearResults', 'Performing hard reload...', 'info');
            location.reload(true); // Force reload from server
        };

        // Initialize on load
        updateTimestamps();
        setInterval(updateTimestamps, 1000); // Update every second
    </script>
</body>
</html>
