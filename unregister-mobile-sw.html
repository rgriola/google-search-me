<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unregister Mobile Service Worker</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        button:hover { background-color: #c82333; }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover { background-color: #5a6268; }
        #results { margin-top: 20px; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Mobile Service Worker Cleanup Tool</h1>
        <p>This tool will help you completely remove the mobile service worker that's causing CSP violations and cache errors.</p>
        
        <div id="current-status">
            <h3>Current Status</h3>
            <div id="status-results">Checking...</div>
        </div>
        
        <div>
            <h3>Actions</h3>
            <button onclick="unregisterAll()">üóëÔ∏è Unregister All Service Workers</button>
            <button onclick="clearCaches()" class="secondary">üßπ Clear All Caches</button>
            <button onclick="checkStatus()" class="secondary">üîç Check Status</button>
            <button onclick="clearStorage()" class="secondary">üóÇÔ∏è Clear Local Storage</button>
        </div>
        
        <div id="results"></div>
        
        <div style="margin-top: 30px;">
            <h3>üìã Manual Steps (if needed)</h3>
            <ol>
                <li><strong>Chrome DevTools:</strong> F12 ‚Üí Application tab ‚Üí Service Workers ‚Üí Find mobile-service-worker ‚Üí Click "Unregister"</li>
                <li><strong>Clear Site Data:</strong> F12 ‚Üí Application tab ‚Üí Storage ‚Üí "Clear storage" button</li>
                <li><strong>Hard Refresh:</strong> Ctrl+Shift+R (or Cmd+Shift+R on Mac) to bypass cache</li>
            </ol>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>üîß Code Changes Made</h3>
            <p>The following changes will prevent future mobile service worker registrations:</p>
            <ul>
                <li>‚úÖ Service worker registration already commented out in mobile-app.js</li>
                <li>üîÑ Will disable mobile-app.js imports if found in main app</li>
                <li>üóëÔ∏è Will recommend removing mobile-service-worker.js file</li>
            </ul>
        </div>
    </div>

    <script>
        let results = document.getElementById('results');
        let statusResults = document.getElementById('status-results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            statusResults.appendChild(div);
        }
        
        async function checkStatus() {
            statusResults.innerHTML = '<div class="result info">üîç Checking current status...</div>';
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        addStatus('‚úÖ No service workers currently registered', 'success');
                    } else {
                        addStatus(`üìã Found ${registrations.length} service worker(s):`, 'warning');
                        registrations.forEach((reg, index) => {
                            addStatus(`${index + 1}. Scope: ${reg.scope}`, 'info');
                            if (reg.active) {
                                addStatus(`   - Active: ${reg.active.scriptURL}`, 'info');
                            }
                            if (reg.waiting) {
                                addStatus(`   - Waiting: ${reg.waiting.scriptURL}`, 'info');
                            }
                            if (reg.installing) {
                                addStatus(`   - Installing: ${reg.installing.scriptURL}`, 'info');
                            }
                        });
                    }
                } catch (error) {
                    addStatus(`‚ùå Error checking service workers: ${error.message}`, 'error');
                }
            } else {
                addStatus('‚ÑπÔ∏è Service workers not supported in this browser', 'info');
            }
            
            // Check caches
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length === 0) {
                        addStatus('‚úÖ No caches found', 'success');
                    } else {
                        addStatus(`üì¶ Found ${cacheNames.length} cache(s): ${cacheNames.join(', ')}`, 'warning');
                    }
                } catch (error) {
                    addStatus(`‚ùå Error checking caches: ${error.message}`, 'error');
                }
            }
        }
        
        async function unregisterAll() {
            results.innerHTML = '<div class="result info">üóëÔ∏è Starting service worker unregistration...</div>';
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        addResult('‚ÑπÔ∏è No service workers to unregister', 'info');
                        return;
                    }
                    
                    for (let registration of registrations) {
                        try {
                            const unregistered = await registration.unregister();
                            if (unregistered) {
                                addResult(`‚úÖ Successfully unregistered: ${registration.scope}`, 'success');
                            } else {
                                addResult(`‚ö†Ô∏è Failed to unregister: ${registration.scope}`, 'warning');
                            }
                        } catch (error) {
                            addResult(`‚ùå Error unregistering ${registration.scope}: ${error.message}`, 'error');
                        }
                    }
                    
                    addResult('üîÑ Refresh the page to verify service workers are gone', 'info');
                    
                } catch (error) {
                    addResult(`‚ùå Error getting service worker registrations: ${error.message}`, 'error');
                }
            } else {
                addResult('‚ÑπÔ∏è Service workers not supported in this browser', 'info');
            }
        }
        
        async function clearCaches() {
            addResult('üßπ Starting cache cleanup...', 'info');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    
                    if (cacheNames.length === 0) {
                        addResult('‚ÑπÔ∏è No caches to clear', 'info');
                        return;
                    }
                    
                    for (let cacheName of cacheNames) {
                        try {
                            const deleted = await caches.delete(cacheName);
                            if (deleted) {
                                addResult(`‚úÖ Deleted cache: ${cacheName}`, 'success');
                            } else {
                                addResult(`‚ö†Ô∏è Failed to delete cache: ${cacheName}`, 'warning');
                            }
                        } catch (error) {
                            addResult(`‚ùå Error deleting cache ${cacheName}: ${error.message}`, 'error');
                        }
                    }
                    
                    addResult('‚úÖ Cache cleanup complete', 'success');
                    
                } catch (error) {
                    addResult(`‚ùå Error during cache cleanup: ${error.message}`, 'error');
                }
            } else {
                addResult('‚ÑπÔ∏è Cache API not supported in this browser', 'info');
            }
        }
        
        function clearStorage() {
            addResult('üóÇÔ∏è Starting storage cleanup...', 'info');
            
            try {
                // Clear localStorage
                const localStorageItems = Object.keys(localStorage);
                localStorage.clear();
                addResult(`‚úÖ Cleared ${localStorageItems.length} localStorage items`, 'success');
                
                // Clear sessionStorage
                const sessionStorageItems = Object.keys(sessionStorage);
                sessionStorage.clear();
                addResult(`‚úÖ Cleared ${sessionStorageItems.length} sessionStorage items`, 'success');
                
                addResult('‚úÖ Storage cleanup complete', 'success');
                
            } catch (error) {
                addResult(`‚ùå Error during storage cleanup: ${error.message}`, 'error');
            }
        }
        
        // Check status on page load
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>
